/** * @module createCourseSteps *  * @name 创建课程步骤 * @version 1.0.0 */define(['urls', 'urlParser', 'jquery.autocomplete', 'IP-fileupload', 'jquery.blockUI'], function(_urls, urlParser) {        if (urlParser && urlParser.userIds) {        var userId = urlParser.userId;    }        function toJsonString(obj) {        var str = "";        for(var i in obj) {            str += '"' + i + '":' + '"' + obj[i] + '",';        }        str = str.replace(/,$/,"");        str = "{" + str + "}";        return str;    }        var $courseStep = $("#CourseCreateStep .courseStep");    var courseTitle = $("#courseTitle");    var coverUrl = _urls["frontcourseUpload"];            function inputValidation(selector, alertText, length, autoFocus, needValidation)    {        var $this = $(selector);        var val = $this.val();        $(".error", $this.parent()).remove();        if (needValidation) {            if (val === "") {                $this.parent().append("<p class='error'>"+ alertText +"不能为空</p>");                if (autoFocus) {$this.focus()};                return false;            }            if (length) {                if (val.length > 100) {                    $this.parent().append("<p class='error'>"+ alertText +"过长</p>");                    if (autoFocus) {$this.focus()};                    return false;                }            };        }        else{            $this.parent().append("<p class='error'>"+ alertText +"</p>");        }        if (autoFocus) {$this.focus()};        return true;    }        var uploadCover = function ($el, coverUrl){        var oBtn = $el.find("#buploadBtn");        var oImg = $el.find("#bcoverBig");        var oIpt = $el.find("#bpicUrl");        new AjaxUpload(oBtn, {            action: coverUrl,            name:"file",            onSubmit:function(file,ext){                if(ext && /^(JPG|JPEG|BMP|jpg|jpeg|png|gif|bmp)$/.test(ext)){                    //ext是后缀名                    oBtn.val("正在上传…");                }else{                    inputValidation("#bpicUrl","不支持非图片格式！",null,false,false);                    return false;                }            },            "onComplete":function(file, response){                if (response.indexOf("PRE") > -1){                    response = response.replace("<PRE>","").replace("</PRE>","");                }                                var msg = eval("("+response+")");                                if(msg.code == 200){                    oBtn.val("上传成功");                    oIpt.val(msg.data);                    oImg.attr("src", msg.data);                } else {                    oBtn.val("重新上传");                }            }        });    }        return {        render:function (){            //s标签            $("#courseTag").autocomplete("/platform/rs/tag/getTagsByName?pageNo=1&pageSize=10", {                width:497,                multiple: true,                delay :10,                minChars:0,                selectFirst :false,                multipleSeparator :",",                matchSubset :false,                parse:function(data){                    var arr = [],                    len = 0;                    $.each(data.data.result,function(i,v){                        var obj = {};                        obj['data'] = v.name;                        obj['result'] = v.name;                        arr[len++] = obj;                    });                    return arr;                },                formatItem:function(data){                    return data;                }            }).result(function(e,row,formatted){                var _that = $("#TagInput");                if(_that.val().replace(/,\s*,/g,",,").replace(/,,+/g,",").split(",").length > 6){                    _that.val(_that.val().replace(/,[^,]+,$/,","));                };            });            //控制最多5个有效标签            $("#TagInput").keyup(function(key){                $(this).val($(this).val().replace(/，/g,",").replace(/,\s*,/g,",,").replace(/,,+/g,","));                if($(this).val().replace(/,$/,"").split(",").length >= 6){                    $(this).val($(this).val().replace(/,[^,]+,?$/,","));                }            });            //e标签                        //页面初始化的时候读出分类数据            $.get(_urls.classifyDetail(1,3), function(result) {                                var sObj_1 = $("#classify_1"),                    sObj_2 = $("#classify_2"),                    sObj_3 = $("#classify_3");                                if (200 == result.code) {                    var data = result.data;                                        //给第一个select添加分类                    sObj_1.append("<option value="+data.id+">"+data.name+"</option>");                    //分类改变触发后续select改变 事件                    sObj_1.change(function() {                        //首先移除下级select中的option                        sObj_2.find("option").remove().end().append('<option value="-1">请选择</option>');                        sObj_3.find("option").remove().end().append('<option value="-1">请选择</option>');                        //判断是否要加载下级select                        if (data.children.length != 0) {                            for (var i in data.children) {                                sObj_2.append("<option value="+data.children[i].id+">"+data.children[i].name+"</option>");                            }                        }                    });                    sObj_2.change(function() {                        //首先移除下级select中的option                        sObj_3.find("option").remove().end().append('<option value="-1">请选择</option>');                        //index代表option在所有option中的索引号                        var index = $(this).find("option:selected").index()-1;                        //判断是否要加载下级select                        if (data.children[index].children.length != 0) {                            for (var i in data.children[index].children) {                                sObj_3.append("<option value="+data.children[index].children[i].id+">"+data.children[index].children[i].name+"</option>");                            }                        }                    });                }                                $("#classifyEnter").click(function() {                    var val_1 = sObj_1.find("option:selected").val();                    var text_1 = sObj_1.find("option:selected").text();                    var val_2 = sObj_2.find("option:selected").val();                    var text_2 = sObj_2.find("option:selected").text();                    var val_3 = sObj_3.find("option:selected").val();                    var text_3 = sObj_3.find("option:selected").text();                                        function addClassify(val, text) {                        var bool = true;                        $(".error", $("#classifyEnter").parent()).remove();                        $(".classifyResult").each(function(i) {                            if ($(this).attr("tid") == val) {                                bool = false;                                return false;                            }                        });                                                if (bool) {                            $("#classifySelected").append('<span class="classifyResult" tid='+val+'>'+text+'<a href="javascript:void(0)">X</a></span>');                        } else {                            inputValidation("#classify_1","该分类已添加！",null,true,false);                        }                    }                                        if (-1 != val_3) {                        addClassify(val_3, text_3);                    } else if (-1 != val_2) {                        addClassify(val_2, text_2);                    } else if (-1 != val_1) {                        addClassify(val_1, text_1);                    }                    else{                        inputValidation("#classify_1","请选择课程分类",null,true,false);                    }                });                                $(".classifyResult").live('click', function() {                    $(this).closest('span').remove();                });                            }, 'json');                        var newCourse = {};                                    uploadCover($("#CourseCreateStep"), coverUrl);                        $("#courseTitle").blur(function(){inputValidation("#courseTitle", "课程标题", 100, false, true)});            $("#castDescription").blur(function(){inputValidation("#castDescription","课程描述", 1000, false, true)});            $(".confirm_1").click(function() {                $("p.error").remove();                var courseTitle = $.trim($("#courseTitle").val());                var castDescription = $.trim($("#castDescription").val());                var courseTag = $.trim($("#courseTag").val()).replace(/,$/,'');                var classifyResult = $(".classifyResult");                var classifyResultIds = '';                                $(".classifyResult").each(function(index, element) {                    classifyResultIds += $(element).attr("tid")+",";                });                 classifyResultIds = classifyResultIds.replace(/,$/,'');                                $("#courseTitle, #castDescription").trigger("blur");                if (!classifyResultIds) {                    inputValidation("#classify_1","请选择课程分类",null,true,false);                    return;                }                                var params = {                    "name" : encodeURIComponent(courseTitle),                    "description" : encodeURIComponent(castDescription),                    "categoryIds" : classifyResultIds,                    "tagNames" : courseTag,                    "coverPath" : $("#bpicUrl").val()                };                                 //$.post('datas/data.json', {}, function(result) {                $.post(_urls.courseCreate, {"jsonString": toJsonString(params)}, function(result) {                    if (200 == result.code) {                        $("a.confirm").parent().append("<p>保存成功</p>");                        newCourse.id = result.data;                        $courseStep.css("backgroundPosition","0 -280px");                        $(".courseStep_1").css("display","none");                        $(".courseStep_3").css("display","none");                        $(".courseStep_2").css("display","block");                    }                }, 'json');            });                        $(".cancel_1").click(function() {                history.go(-1);            });                        function videoUploadFileHigh() {                var _this = this;                //得到视频保存路径                $.get(_urls.videoGeneratePath, function(result) {                    if (200 == result.code) {                        $("#videoFilePath").val(result.data.path);                                                var id          = _this.id,                            fileName    = $(_this).val();                                                    //验证是否为flv或者MP4文件                        if(fileName.substring(fileName.length-4).toLowerCase() != ".flv" && fileName.substring(fileName.length-4).toLowerCase() != ".mp4") {                            inputValidation("#showFileName", '请上传flv或者MP4文件',null, false, false);                            return false;                        };                                                $.blockUI({ message: '<h1>上传中，请稍等...</h1>' });                         $.ajaxFileUpload({                            url: _urls.videoUpload,                            secureuri: false,                            fileElementId: id,                            dataType: 'json',                            data:{"level":"high","path":$("#videoFilePath").val()},                            success: function (data, status){                                //回调                                $.unblockUI();                                //alert(data.message);                                if(data.code == 200) {                                    $("#showFileName").text("当前文件："+fileName).show();                                    $("#HiddenVideoUrl").val(data.data);                                   }                                $("#courseWareFile").unbind().bind("change", videoUploadFileHigh);                            }                        });                    }                }, "json");            }                        function DocUploadFile() {                var id          = this.id,                    fileName    = $(this).val();                                    //验证是否为doc、docx、txt、pdf、ppt或者pptx                switch(fileName.split(".")[fileName.split(".").length-1].toLowerCase()){                    case "doc":                    case "docx":                    case "pdf":                    case "ppt":                    case "pptx":                        break;                    default:                        inputValidation("#showFileName", '请上传doc、docx、pdf、ppt或者pptx文档',null, false, false);                        return false;                        break;                }                                $.blockUI({ message: '<h1>上传中，请稍等...</h1>' });                 $.ajaxFileUpload({                    url: _urls.courseUpload,                    secureuri: false,                    fileElementId: id,                    dataType: 'json',                    type:"POST",                    success: function (data, status){                        //回调                        $.unblockUI();                        //alert(data.message);                        if(data.code == 200) {                            $("#showFileName").text("当前文件："+fileName).show();                            $("#HiddenDocUrl").val(data.data);                        }                        $("#courseWareFile").unbind("change").bind("change", DocUploadFile);                    }                });            }                        function noSelect() {               inputValidation("#cType", '请选择课件类型',null, false, false);            }                        if (0 == $("#cType option:selected").val()) {                //没选择                $("#courseWareFile").bind("change", noSelect);            } else if (1 == $("#cType option:selected").val()) {                //上传视频                $("#courseWareFile").bind("change", videoUploadFileHigh);            } else if (2 == $("#cType option:selected").val()) {                //上传文档                $("#courseWareFile").bind("change", DocUploadFile);            }                        $("#cType").change(function() {                var val = $(this).find("option:selected").val();                switch(val){                    case "0":                        $("#courseWareFile").unbind("change").bind("change", noSelect);                        break;                    case "1":                        $("#courseWareFile").unbind("change").bind("change", videoUploadFileHigh);                        break;                    case "2":                        $("#courseWareFile").unbind("change").bind("change", DocUploadFile);                        break;                    default:                        break;                }            });            $("#cName").blur(function(){                inputValidation("#cName", "课件名称", 100, false, true);            });            $("#cDesc").blur(function(){                inputValidation("#cDesc", "课件描述", 1000, false, true);            });                        //创建课程 添加课件            $(".affirmAdd").click(function() {                $(".error").remove();                var cName = $.trim($("#cName").val());                var cDesc = $.trim($("#cDesc").val());                var cType = $("#cType option:selected").val();                var bcsCameraHighUrl = $("#HiddenVideoUrl").val();                var attachPath = $("#HiddenDocUrl").val();                                if (!cName) {                    $("#cName").trigger("blur");                    return;                }                                if (!cDesc) {                    $("#cDesc").trigger("blur");                    return;                }                                 if(bcsCameraHighUrl == '' && attachPath == '') {                    inputValidation("#courseWareFile", "请上传课件", null, false, false);                    return false;                };                                if (0 == cType) {                    inputValidation("#cType", "请选择课件类型", null, false, false);                } else if (1 == cType) {                    var param = {                        "name": cName,                        "description" : cDesc,                        "type":2,                        "cameraUrl" : $("#videoFilePath").val(),                        "bcsCameraHighUrl" : bcsCameraHighUrl                    };                                        addCourseware(_urls.createVideoElement, toJsonString(param));                } else if (2 == cType) {                    var param = {                        "name": cName,                        "description" : cDesc,                        "type":4,                        "attachPath":attachPath                    };                                        addCourseware(_urls.createDocElement, toJsonString(param));                }                                function addCourseware(url, jsonStr) {                    $(".error", $("#docFilePath").parent()).remove();                    $.post(url, {"jsonString":jsonStr}, function(result) {                        if (200 == result.code) {                            $(".addCourseDetail").append('<li class="clearfix"><div class="courseDetailName">'+cName+'</div><div class="act"><a tid='+result.data+' class="del" href="javascript:void(0)">删除</a></div><div class="ctime">'+new Date().toLocaleString()+'</div></li>');                            $("#cName").val("");                            $("#cDesc").val("");                            $("#courseWareFile").val("");                            $("#showFileName").text("");                            $("#cType").find("option").eq(0).attr("selected","selected");                            $("#courseWareFile").unbind("change").bind("change", noSelect);                            $("#HiddenVideoUrl").val("");                            $("#HiddenDocUrl").val("");                        }                    }, 'json');                }            });                        $(".act .del").live("click", function(){                                var _this = $(this);                var id = _this.attr("tid");                                $.get("/platform/rs/element/delete/" + id, {id : id}, function(result) {                    if (200 == result.code) {                        _this.closest("li").remove();                    }                }, 'json');            });                        $(".cancelAdd").click(function() {                $("#cName").val("");                $("#cDesc").val("");                $("#cType").find("option").eq(0).attr("selected","selected");                $("#courseWareFile").val("");                $("#showFileName").text("");            });                        $(".confirm_2").click(function() {                            var id = newCourse.id;                var ids = new Array();                                $(".addCourseDetail .del").each(function(index, element) {                    ids.push('"'+$(element).attr("tid")+'"');                });                                var param = {                    "elementList" : ids                };                                $.post("/platform/rs/course/addElements/" + id, {jsonString:'{"elementIds":['+ids+'],"id":"'+id+'"}',id:id}, function(result) {                    if (200 == result.code) {                        $courseStep.css("backgroundPosition","0 0");                        $(".courseStep_1").css("display","none");                        $(".courseStep_2").css("display","none");                        $(".courseStep_3").css("display","block");                        //alert(result.message);                        $.get("/platform/rs/course/updatestatus", {courseId:id, status:2}, function(result){                            if (200 == result.code) {                                //console.log(result.message);                            }                        });                    }                }, 'json');                            });        },        doInit:function (){            this.render();        }    };    });